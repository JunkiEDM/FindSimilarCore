@using SoundFingerprinting.DAO.Data;

@{
    ViewData["Title"] = "Home Page";
}

@section Head {
    
}

<table id="data" class="table table-sm">
    <thead class="thead-light">
        <tr>
            <th scope="col">#</th>
            <th scope="col">File</th>
            <th scope="col">Seconds</th>
        </tr>
    </thead>
    <tbody>

@foreach (TrackData track in ViewBag.Tracks) {
        <tr>
            <th scope="row">
                <!-- <i class="far fa-play-circle"></i> -->
                <audio preload="auto" src="/api/streaming/@track.TrackReference.Id"></audio>
            </th>            
            <td><small>@track.Title</small></td>
            <td><small>@track.Length.ToString("N")</small></td>
        </tr>

}
    </tbody>
</table>

<div id="editForm">
    <form>
        <div class="form-inline mb-2">
            <input type="text" class="form-control mr-2" id="editRowText" placeholder="To edit...">
            <button type="submit" class="btn btn-primary btn-sm">Save</button>
        </div>
    </form>
</div>

<input type="button" id="goto_first" class="btn btn-primary btn-sm" value="first">
<input type="button" id="goto_prev" class="btn btn-primary btn-sm" value="prev">
<input type="button" id="goto_next" class="btn btn-primary btn-sm" value="next">
<input type="button" id="goto_last" class="btn btn-primary btn-sm" value="last">


@section Scripts { 
    @* 
    Javascript sections
    *@

<script type="text/javascript">

// hide edit area
$('#editForm').hide();
var editing = false;

function highlightRow(tableRowIndex) {
    
    // if .table-active has reached the last, start again
    if (tableRowIndex < 0  || (tableRowIndex + 1) > $('#data tbody tr').length )
        tableRowIndex = 0;    
    
    // check if element exists
    if($('#data tbody tr:eq('+tableRowIndex+')').length > 0)
    {
        // remove other highlights
        $('#data tbody tr').removeClass('table-active');
        
        // highlight your target
        $('#data tbody tr:eq('+tableRowIndex+')').addClass('table-active');

        // and make sure to scroll the row into view
        // $('#data tbody tr:eq('+tableRowIndex+')')[0].scrollIntoView({
            // behavior: "auto", // smooth or "auto" or "instant"
            // block: "end" // start or "end"
        // });

        // and play
        $('audio').each(function() 
        {
            $(this)[0].pause();
        });
        var player =  $('#data tbody tr:eq('+tableRowIndex+') audio')[0];
        player.play();
        var playericon =  $('#data tbody tr:eq('+tableRowIndex+') i');
        playericon.removeClass('fa-play-circle');
        playericon.addClass('fa-pause-circle');
    }
}

$('#goto_first').click(function() {
    highlightRow(0);
});

$('#goto_prev').click(function() {
    highlightRow($('#data tbody tr.table-active').index() - 1);
});

$('#goto_next').click(function() {
    highlightRow($('#data tbody tr.table-active').index() + 1);
});

$('#goto_last').click(function() {
    highlightRow($('#data tbody tr:last').index());
});


// Show edit form
function displayEditForm() {
    editing = true;
    $('#editForm').show();

    // find currently selected row index
    var tableRowIndex = $('#data tbody tr.table-active').index();
    if (tableRowIndex < 0  || (tableRowIndex + 1) > $('#data tbody tr').length )
        tableRowIndex = 0;    
    
    // ensure the target is highlightRowed
    $('#data tbody tr:eq('+tableRowIndex+')').addClass('table-active');

    $('#editForm #editRowText').val(tableRowIndex);
    $('#editForm #editRowText').select();
}

// user saves edits
$('#editForm form').submit(function (e) {
    editing = false;
    e.preventDefault();

    // Ajax to update value in database
    $.get('#', '', function () {
        $('#editForm').hide();
        alert('Saving ' + $('#editForm #editRowText').val());
    });    
});

// user can cancel edit by pressing escape
$('#editForm').keydown(function (e) {
    if (editing && e.which == 27) {
        editing = false;
        $('#editForm').hide();
    }
});

// handle key presses
$(document).keydown(function (e) {
    
    if (!editing) {
        e.preventDefault();
        switch(e.which) 
        {        
            case 38:
                // up arrow
                $('#goto_prev').trigger('click');
                break;
            case 40:
                // down Arrow
                $('#goto_next').trigger('click');
                break;
            case 13:
                // enter
            case 32:
                // spacebar
            case 113:
                // F2
                displayEditForm();
                break;
        }
    }
 });

// attach an onclick event handler to the table rows 
$('#data tbody tr').click( function() {
    editing = false;
    $('#editForm').hide();
    highlightRow(($(this).index()));
});

// attach an onclick event handler to the playpause buttons
$('#data tbody tr th DISABLED').click( function() {

    var player = $(this).siblings("audio")[0];

    if (player.paused) {
        player.play();
        $(this).removeClass('fa-play-circle');
        $(this).addClass('fa-pause-circle');
    }
    else {
        player.pause();
        $(this).removeClass('fa-pause-circle');
        $(this).addClass('fa-play-circle');
    }
});


</script>
}